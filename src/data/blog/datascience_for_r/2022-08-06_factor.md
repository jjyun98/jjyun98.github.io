---
title: "factor"
format: 
  html:
    code-fold: false
    badges: true
author: '조윤호'
date: '8/6/2022'
title-block-banner: true
jupyter: R
image: "rfordatascience.jpg"
categories: [R]
---
# factor

factor in ggplot, factor in tibble(fct_record, fct_collapse)


```R
library('tidyverse')
# 플롯 최적화 설정
options(
  repr.plot.width = 8,
  repr.plot.height = 5,
  repr.plot.res = 150
)
theme_set(theme_minimal(base_size = 10))
```

## 팩터형이란?

- 팩터형은 범주형 변수에 사용되는데, 범주형 변수란 가질 수 있는 값이 미리 고정되고 또 알려진 변수를 말한다.<br>
팩터형은 문자형 벡터를 알파벳순이 아닌 순서로 표시하고 싶을 때도 이용할 수 있다.<br>
팩터형이 문자형보다 다루기 쉽기에, 베이스 R의 함수들은 문자형을 자동으로 팩터형으로 변환한다.<br>
다시 말해 팩터형이 사실 도움이 되지 않는 경우에도 나타나는 경우가 많이 있다는 의미다.

`-` 월을 기록한 변수 예시


```R
x1 <- c("Dec", "Apr", "Jan", "Mar")
```


```R
x1
```


<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>'Dec'</li><li>'Apr'</li><li>'Jan'</li><li>'Mar'</li></ol>



`-` 문자형의 경우 오타를 입력했거나 정렬을 하고자 할 때 유용한 순서로 정렬이 되지 않는다.


```R
sort(x1)
```


<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>'Apr'</li><li>'Dec'</li><li>'Jan'</li><li>'Mar'</li></ol>



- 팩터형을 만들기 위해서는 먼저 선례(?)를 만들어 주어야 한다.


```R
month_levels <- c(
    "Jan", "Feb", "Mar", "Apr", "May", "Jun",
    "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
    )
```


```R
month_levels
```


<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>'Jan'</li><li>'Feb'</li><li>'Mar'</li><li>'Apr'</li><li>'May'</li><li>'Jun'</li><li>'Jul'</li><li>'Aug'</li><li>'Sep'</li><li>'Oct'</li><li>'Nov'</li><li>'Dec'</li></ol>




```R
y1 <- factor(x1, levels = month_levels)
```


```R
y1
```


<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>Dec</li><li>Apr</li><li>Jan</li><li>Mar</li></ol>

<details>
	<summary style=display:list-item;cursor:pointer>
		<strong>Levels</strong>:
	</summary>
	<style>
	.list-inline {list-style: none; margin:0; padding: 0}
	.list-inline>li {display: inline-block}
	.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
	</style>
	<ol class=list-inline><li>'Jan'</li><li>'Feb'</li><li>'Mar'</li><li>'Apr'</li><li>'May'</li><li>'Jun'</li><li>'Jul'</li><li>'Aug'</li><li>'Sep'</li><li>'Oct'</li><li>'Nov'</li><li>'Dec'</li></ol>
</details>


`-` 선례를 바탕으로 정렬


```R
sort(y1)
```


<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>Jan</li><li>Mar</li><li>Apr</li><li>Dec</li></ol>

<details>
	<summary style=display:list-item;cursor:pointer>
		<strong>Levels</strong>:
	</summary>
	<style>
	.list-inline {list-style: none; margin:0; padding: 0}
	.list-inline>li {display: inline-block}
	.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
	</style>
	<ol class=list-inline><li>'Jan'</li><li>'Feb'</li><li>'Mar'</li><li>'Apr'</li><li>'May'</li><li>'Jun'</li><li>'Jul'</li><li>'Aug'</li><li>'Sep'</li><li>'Oct'</li><li>'Nov'</li><li>'Dec'</li></ol>
</details>


`-` 오타가 추가된 예시


```R
x2 <- c("Dec", "Apr", "Jam", "Mar")
```


```R
y2 <- factor(x2, levels = month_levels)
```

`-` 레벨 집합(선례)에 포함되지 않는 값은 NA로 변환된다.


```R
y2
```


<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>Dec</li><li>Apr</li><li>&lt;NA&gt;</li><li>Mar</li></ol>

<details>
	<summary style=display:list-item;cursor:pointer>
		<strong>Levels</strong>:
	</summary>
	<style>
	.list-inline {list-style: none; margin:0; padding: 0}
	.list-inline>li {display: inline-block}
	.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
	</style>
	<ol class=list-inline><li>'Jan'</li><li>'Feb'</li><li>'Mar'</li><li>'Apr'</li><li>'May'</li><li>'Jun'</li><li>'Jul'</li><li>'Aug'</li><li>'Sep'</li><li>'Oct'</li><li>'Nov'</li><li>'Dec'</li></ol>
</details>


- `parse_factor`사용하면 NA가 나올시 warning뜬다.


```R
y2 <- parse_factor(x2, levels = month_levels)
```

    Warning message:
    "1 parsing failure.
    row col           expected actual
      3  -- value in level set    Jam
    "


`-` `levels`입력안하면 그냥 알파벳 순서로 나열


```R
factor(x1)
```


<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>Dec</li><li>Apr</li><li>Jan</li><li>Mar</li></ol>

<details>
	<summary style=display:list-item;cursor:pointer>
		<strong>Levels</strong>:
	</summary>
	<style>
	.list-inline {list-style: none; margin:0; padding: 0}
	.list-inline>li {display: inline-block}
	.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
	</style>
	<ol class=list-inline><li>'Apr'</li><li>'Dec'</li><li>'Jan'</li><li>'Mar'</li></ol>
</details>


## factor in ggplot

`-` 설문조사 샘플 데이터


```R
gss_cat %>% head
```


<table class="dataframe">
<caption>A tibble: 6 x 9</caption>
<thead>
	<tr><th scope=col>year</th><th scope=col>marital</th><th scope=col>age</th><th scope=col>race</th><th scope=col>rincome</th><th scope=col>partyid</th><th scope=col>relig</th><th scope=col>denom</th><th scope=col>tvhours</th></tr>
	<tr><th scope=col>&lt;int&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;int&gt;</th></tr>
</thead>
<tbody>
	<tr><td>2000</td><td>Never married</td><td>26</td><td>White</td><td>$8000 to 9999 </td><td>Ind,near rep      </td><td>Protestant        </td><td>Southern baptist</td><td>12</td></tr>
	<tr><td>2000</td><td>Divorced     </td><td>48</td><td>White</td><td>$8000 to 9999 </td><td>Not str republican</td><td>Protestant        </td><td>Baptist-dk which</td><td>NA</td></tr>
	<tr><td>2000</td><td>Widowed      </td><td>67</td><td>White</td><td>Not applicable</td><td>Independent       </td><td>Protestant        </td><td>No denomination </td><td> 2</td></tr>
	<tr><td>2000</td><td>Never married</td><td>39</td><td>White</td><td>Not applicable</td><td>Ind,near rep      </td><td>Orthodox-christian</td><td>Not applicable  </td><td> 4</td></tr>
	<tr><td>2000</td><td>Divorced     </td><td>25</td><td>White</td><td>Not applicable</td><td>Not str democrat  </td><td>None              </td><td>Not applicable  </td><td> 1</td></tr>
	<tr><td>2000</td><td>Married      </td><td>25</td><td>White</td><td>$20000 - 24999</td><td>Strong democrat   </td><td>Protestant        </td><td>Southern baptist</td><td>NA</td></tr>
</tbody>
</table>



팩터형이 티블로 저장되면 해당하는 레벨들을 쉽게 볼 수 없는데 볼 수 있는 방법1)은 `count`이다.


```R
gss_cat %>%
count(race)
```


<table class="dataframe">
<caption>A tibble: 3 x 2</caption>
<thead>
	<tr><th scope=col>race</th><th scope=col>n</th></tr>
	<tr><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;int&gt;</th></tr>
</thead>
<tbody>
	<tr><td>Other</td><td> 1959</td></tr>
	<tr><td>Black</td><td> 3129</td></tr>
	<tr><td>White</td><td>16395</td></tr>
</tbody>
</table>



방법2) 막대 그래프


```R
ggplot(gss_cat, aes(race)) + geom_bar()
```


    
![png](2022-08-06_factor_files/2022-08-06_factor_32_0.png)
    


`scale_x_discrete(drop = FALSE)` : ggplot에서 값이 없는 레벨을 보이게하기


```R
ggplot(gss_cat, aes(race)) +
geom_bar() +
scale_x_discrete(drop = FALSE)
```


    
![png](2022-08-06_factor_files/2022-08-06_factor_34_0.png)
    


유효하지만 이 데이터 셋에서 나타나지 않는 값을 나타냄

`-` 종교에 따른 하루 TV 시청시간의 평균


```R
relig_summary <- gss_cat %>%
group_by(relig) %>%
summarize(
    age = mean(age, na.rm = TRUE),
    tvhours = mean(tvhours, na.rm = TRUE),
    n = n()
    )

ggplot(relig_summary, aes(tvhours, relig)) + geom_point()
```


    
![png](2022-08-06_factor_files/2022-08-06_factor_37_0.png)
    


`-` tvhours순위로 religion순위 재 정렬


```R
ggplot(relig_summary, aes(tvhours, fct_reorder(relig, tvhours))) + geom_point()
```


    
![png](2022-08-06_factor_files/2022-08-06_factor_39_0.png)
    


`-` tibble자체를 순서 정렬시키고 그리는 방법


```R
relig_summary %>%
mutate(relig = fct_reorder(relig, tvhours)) %>%
ggplot(aes(tvhours, relig)) +
geom_point()
```


    
![png](2022-08-06_factor_files/2022-08-06_factor_41_0.png)
    


`-` 보고서 소득 레벨에 따라 평균나이가 어떻게 변화하는지 보여주는 plot


```R
rincome_summary <- gss_cat %>%
group_by(rincome) %>%
summarize(
    age = mean(age, na.rm = TRUE),
    tvhours = mean(tvhours, na.rm = TRUE),
    n = n()
    )
```


```R
rincome_summary
```


<table class="dataframe">
<caption>A tibble: 16 x 4</caption>
<thead>
	<tr><th scope=col>rincome</th><th scope=col>age</th><th scope=col>tvhours</th><th scope=col>n</th></tr>
	<tr><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th></tr>
</thead>
<tbody>
	<tr><td>No answer     </td><td>45.45029</td><td>2.904762</td><td> 183</td></tr>
	<tr><td>Don't know    </td><td>45.60902</td><td>3.411290</td><td> 267</td></tr>
	<tr><td>Refused       </td><td>47.61082</td><td>2.481973</td><td> 975</td></tr>
	<tr><td>$25000 or more</td><td>44.21217</td><td>2.234208</td><td>7363</td></tr>
	<tr><td>$20000 - 24999</td><td>41.53365</td><td>2.784753</td><td>1283</td></tr>
	<tr><td>$15000 - 19999</td><td>39.96180</td><td>2.912245</td><td>1048</td></tr>
	<tr><td>$10000 - 14999</td><td>41.11301</td><td>3.016541</td><td>1168</td></tr>
	<tr><td>$8000 to 9999 </td><td>41.08235</td><td>3.148571</td><td> 340</td></tr>
	<tr><td>$7000 to 7999 </td><td>38.24468</td><td>2.645455</td><td> 188</td></tr>
	<tr><td>$6000 to 6999 </td><td>40.29907</td><td>3.174312</td><td> 215</td></tr>
	<tr><td>$5000 to 5999 </td><td>37.81057</td><td>3.163793</td><td> 227</td></tr>
	<tr><td>$4000 to 4999 </td><td>38.87500</td><td>3.145299</td><td> 226</td></tr>
	<tr><td>$3000 to 3999 </td><td>37.82182</td><td>3.312102</td><td> 276</td></tr>
	<tr><td>$1000 to 2999 </td><td>34.54430</td><td>3.004525</td><td> 395</td></tr>
	<tr><td>Lt $1000      </td><td>40.51049</td><td>3.361842</td><td> 286</td></tr>
	<tr><td>Not applicable</td><td>56.10628</td><td>3.791468</td><td>7043</td></tr>
</tbody>
</table>




```R
ggplot(rincome_summary, aes(age, fct_reorder(rincome, age))) + geom_point()
```


    
![png](2022-08-06_factor_files/2022-08-06_factor_45_0.png)
    


`-` 해당없음(Not applicable)을 다른 특별한 레벨들과 함께 앞으로 가져오기


```R
ggplot(rincome_summary, aes(age, fct_relevel(rincome, "Not applicable"))) +
geom_point()
```


    
![png](2022-08-06_factor_files/2022-08-06_factor_47_0.png)
    



```R
by_age <- gss_cat %>%
filter(!is.na(age)) %>%
count(age, marital) %>%
group_by(age) %>%
mutate(prop = n / sum(n))
```


```R
by_age %>% head
```


<table class="dataframe">
<caption>A grouped_df: 6 x 4</caption>
<thead>
	<tr><th scope=col>age</th><th scope=col>marital</th><th scope=col>n</th><th scope=col>prop</th></tr>
	<tr><th scope=col>&lt;int&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><td>18</td><td>Never married</td><td> 89</td><td>0.978021978</td></tr>
	<tr><td>18</td><td>Married      </td><td>  2</td><td>0.021978022</td></tr>
	<tr><td>19</td><td>Never married</td><td>234</td><td>0.939759036</td></tr>
	<tr><td>19</td><td>Divorced     </td><td>  3</td><td>0.012048193</td></tr>
	<tr><td>19</td><td>Widowed      </td><td>  1</td><td>0.004016064</td></tr>
	<tr><td>19</td><td>Married      </td><td> 11</td><td>0.044176707</td></tr>
</tbody>
</table>




```R
ggplot(by_age, aes(age, prop, color = marital)) +
geom_line(na.rm = TRUE)
```


    
![png](2022-08-06_factor_files/2022-08-06_factor_50_0.png)
    


`fct_reorder2` : 가장 큰 x값과 연관된 y값으로 팩터형을 재정렬한다.<br>
선 색상은 범례와 정렬되므로 이렇게 하면 plot읽기가 쉬워진다.


```R
ggplot(by_age, aes(age, prop, color = fct_reorder2(marital, age, prop))) +
geom_line() +
labs(color = "marital")
```


    
![png](2022-08-06_factor_files/2022-08-06_factor_52_0.png)
    


`fct_infreq` : 빈도 오름차순으로 레벨 정렬


```R
gss_cat %>%
mutate(marital = marital %>% fct_infreq() %>% fct_rev()) %>%
ggplot(aes(marital)) +
geom_bar()
```


    
![png](2022-08-06_factor_files/2022-08-06_factor_54_0.png)
    


## tibble속 factor값 수정


```R
gss_cat %>% count(partyid)
```


<table class="dataframe">
<caption>A tibble: 10 x 2</caption>
<thead>
	<tr><th scope=col>partyid</th><th scope=col>n</th></tr>
	<tr><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;int&gt;</th></tr>
</thead>
<tbody>
	<tr><td>No answer         </td><td> 154</td></tr>
	<tr><td>Don't know        </td><td>   1</td></tr>
	<tr><td>Other party       </td><td> 393</td></tr>
	<tr><td>Strong republican </td><td>2314</td></tr>
	<tr><td>Not str republican</td><td>3032</td></tr>
	<tr><td>Ind,near rep      </td><td>1791</td></tr>
	<tr><td>Independent       </td><td>4119</td></tr>
	<tr><td>Ind,near dem      </td><td>2499</td></tr>
	<tr><td>Not str democrat  </td><td>3690</td></tr>
	<tr><td>Strong democrat   </td><td>3490</td></tr>
</tbody>
</table>



`fct_recode` : 미리 입력한 대로 팩터 값을 바꿔준다(명시적으로 언급하지 않은 것은 그대로 둠)


```R
gss_cat %>%
mutate(partyid = fct_recode(partyid,
                            "Repubican, strong"     = "Strong republican",
                            "Repubican, weak"       = "Not str republican",
                            "Independent, near rep" = "Ind,near rep",
                            "Independent, near dem" = "Ind,near dem",
                            "Democrat, weak"        = "Not str democrat",
                            "Democrat, strong"      = "Strong democrat"
                            )) %>%
count(partyid)
```


<table class="dataframe">
<caption>A tibble: 10 x 2</caption>
<thead>
	<tr><th scope=col>partyid</th><th scope=col>n</th></tr>
	<tr><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;int&gt;</th></tr>
</thead>
<tbody>
	<tr><td>No answer            </td><td> 154</td></tr>
	<tr><td>Don't know           </td><td>   1</td></tr>
	<tr><td>Other party          </td><td> 393</td></tr>
	<tr><td>Repubican, strong    </td><td>2314</td></tr>
	<tr><td>Repubican, weak      </td><td>3032</td></tr>
	<tr><td>Independent, near rep</td><td>1791</td></tr>
	<tr><td>Independent          </td><td>4119</td></tr>
	<tr><td>Independent, near dem</td><td>2499</td></tr>
	<tr><td>Democrat, weak       </td><td>3690</td></tr>
	<tr><td>Democrat, strong     </td><td>3490</td></tr>
</tbody>
</table>



- 나머지(No answer)등을 Other로 묶어서 처리해버리기


```R
gss_cat %>%
mutate(partyid = fct_recode(partyid,
                            "Repubican, strong"     = "Strong republican",
                            "Repubican, weak"       = "Not str republican",
                            "Independent, near rep" = "Ind,near rep",
                            "Independent, near dem" = "Ind,near dem",
                            "Democrat, weak"        = "Not str democrat",
                            "Democrat, strong"      = "Strong democrat",
                            "Other"                 = "No answer",
                            "Other"                 = "Don't know",
                            "Other"                 = "Other party"
                            )) %>%
count(partyid)
```


<table class="dataframe">
<caption>A tibble: 8 x 2</caption>
<thead>
	<tr><th scope=col>partyid</th><th scope=col>n</th></tr>
	<tr><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;int&gt;</th></tr>
</thead>
<tbody>
	<tr><td>Other                </td><td> 548</td></tr>
	<tr><td>Repubican, strong    </td><td>2314</td></tr>
	<tr><td>Repubican, weak      </td><td>3032</td></tr>
	<tr><td>Independent, near rep</td><td>1791</td></tr>
	<tr><td>Independent          </td><td>4119</td></tr>
	<tr><td>Independent, near dem</td><td>2499</td></tr>
	<tr><td>Democrat, weak       </td><td>3690</td></tr>
	<tr><td>Democrat, strong     </td><td>3490</td></tr>
</tbody>
</table>



✖︎ 서로 같지 않은 범주들을 함께 묶는다면 잘못된 결과를 도출할 수 있으므로 신중히 사용해야 한다.

`fct_collapse` : `fct_recode`와 비슷한데 다수를 하나로 병합하고자 할 때 더 편함


```R
gss_cat %>%
mutate(partyid = fct_collapse(partyid,
                              other = c("No answer", "Don't know", "Other party"),
                              rep = c("Strong republican", "Not str republican"),
                              ind = c("Ind,near rep", "Independent", "Ind,near dem"),
                              dem = c("Not str democrat", "Strong democrat")
                              )) %>% 
count(partyid)
```


<table class="dataframe">
<caption>A tibble: 4 x 2</caption>
<thead>
	<tr><th scope=col>partyid</th><th scope=col>n</th></tr>
	<tr><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;int&gt;</th></tr>
</thead>
<tbody>
	<tr><td>other</td><td> 548</td></tr>
	<tr><td>rep  </td><td>5346</td></tr>
	<tr><td>ind  </td><td>8409</td></tr>
	<tr><td>dem  </td><td>7180</td></tr>
</tbody>
</table>



`-` 상위 1등과 나머지는 Other로 묶어서 비교하기


```R
gss_cat %>%
mutate(relig = fct_lump(relig)) %>%
count(relig)
```


<table class="dataframe">
<caption>A tibble: 2 x 2</caption>
<thead>
	<tr><th scope=col>relig</th><th scope=col>n</th></tr>
	<tr><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;int&gt;</th></tr>
</thead>
<tbody>
	<tr><td>Protestant</td><td>10846</td></tr>
	<tr><td>Other     </td><td>10637</td></tr>
</tbody>
</table>



`-` 상위 4등까지만 보고 나머지들은 전부 Other로 묶기


```R
gss_cat  %>% mutate(relig = fct_lump(relig, n = 4)) %>%
count(relig, sort = TRUE) %>%
print(n = Inf)
```

    [90m# A tibble: 5 x 2[39m
      relig          n
      [3m[90m<fct>[39m[23m      [3m[90m<int>[39m[23m
    [90m1[39m Protestant [4m1[24m[4m0[24m846
    [90m2[39m Catholic    [4m5[24m124
    [90m3[39m None        [4m3[24m523
    [90m4[39m Other       [4m1[24m301
    [90m5[39m Christian    689

