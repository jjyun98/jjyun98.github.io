---
author: Jo YunHo
pubDatetime: 2022-09-12T10:00:00Z
modDatetime: 2025-01-17T15:00:00Z
title: R 모델링 실전편 - 다이아몬드 가격과 항공편 운항 분석 (12)
slug: "r-modeling-diamond-flight-analysis"
featured: true
draft: false
tags:
  - R
  - Modeling
  - Data Analysis
  - Regression Analysis
  - Time Series
  - Diamond Analysis
  - Flight Analysis
  - modelr
description: "R의 실제 데이터를 활용한 모델링 실전 예제. 다이아몬드 가격 예측과 항공편 운항 패턴 분석을 통해 실무 모델링 워크플로우를 체계적으로 학습합니다."
---

> 📌 참고 자료:  
> [modelr 공식 문서](https://modelr.tidyverse.org/) | [R for Data Science - Model Building](https://r4ds.had.co.nz/model-building.html)

## Table of contents

## 개요

**실무 모델링**은 이론적 지식을 실제 데이터에 적용하여 의미 있는 인사이트를 추출하는 과정입니다. 단순한 패턴 찾기를 넘어서 도메인 지식과 통계적 기법을 결합하여 현실 세계의 복잡한 현상을 이해해야 합니다.

이번 포스팅에서는 **다이아몬드 가격 예측**과 **항공편 운항 패턴 분석**이라는 두 가지 실전 예제를 통해 체계적인 모델링 워크플로우와 실무에서 자주 마주치는 문제들을 해결하는 방법을 알아보겠습니다!

## 1. 환경 설정 및 라이브러리 로드

### 필수 패키지 설치 및 로드

```r
# 패키지 로드
library('tidyverse')      # 데이터 조작과 시각화
library('modelr')         # 모델링 도구
library('nycflights13')   # 항공편 데이터
library('lubridate')      # 날짜 처리
library('splines')        # 스플라인 함수

# 플롯 최적화 설정
options(
  repr.plot.width = 8,
  repr.plot.height = 5,
  repr.plot.res = 150
)

# 테마 설정
theme_set(theme_minimal(base_size = 10))
```

## 2. 예제 1: 다이아몬드 가격 예측 모델

### 역설적 현상 발견

**"낮은 품질의 다이아몬드가 더 비싼 이유는 무엇인가?"**

```r
# 품질별 가격 분포 확인
ggplot(diamonds, aes(cut, price)) + geom_boxplot()
ggplot(diamonds, aes(color, price)) + geom_boxplot()  
ggplot(diamonds, aes(clarity, price)) + geom_boxplot()
```

![cut vs price](@/assets/images/2022-09-12_모델링2_files/2022-09-12_모델링2_6_0.png)

![color vs price](@/assets/images/2022-09-12_모델링2_files/2022-09-12_모델링2_6_1.png)

![clarity vs price](@/assets/images/2022-09-12_모델링2_files/2022-09-12_모델링2_6_2.png)

#### 🤔 놀라운 발견
품질이 떨어지는 다이아몬드(Fair cut, J color, I1 clarity)가 평균적으로 더 높은 가격을 보입니다. 이는 직관과 반대되는 현상입니다!

### 혼재변수(Confounding Variable) 발견

```r
# 캐럿과 가격의 관계 확인
ggplot(diamonds, aes(carat, price)) +
  geom_hex(bins = 50)
```

![carat vs price](@/assets/images/2022-09-12_모델링2_files/2022-09-12_모델링2_8_0.png)

#### 💡 핵심 인사이트
**캐럿(무게)이 숨겨진 혼재변수**입니다. 품질이 낮은 다이아몬드는 일반적으로 더 무겁고, 무게가 가격에 미치는 영향이 품질보다 크기 때문입니다.

### 데이터 전처리와 변환

```r
# 데이터 정제 및 로그 변환
diamonds2 <- diamonds %>%
  filter(carat <= 2.5) %>%    # 상위 99.7% 데이터만 사용
  mutate(
    lprice = log2(price),      # 가격 로그 변환
    lcarat = log2(carat)       # 캐럿 로그 변환
  )

# 로그 변환 후 관계 확인
ggplot(diamonds2, aes(lcarat, lprice)) +
  geom_hex(bins = 30)
```

![log transformed relationship](@/assets/images/2022-09-12_모델링2_files/2022-09-12_모델링2_13_0.png)

#### ✅ 로그 변환의 효과
- **선형성 개선**: 복잡한 곡선 관계가 선형으로 변환
- **해석 용이성**: 로그 차이는 비율 변화를 의미
- **등분산성**: 잔차의 분산이 더 균등해짐

### 캐럿 효과 제거 모델링

```r
# 1단계: 캐럿만 사용한 기본 모델
mod_diamond <- lm(lprice ~ lcarat, data = diamonds2)

# 예측선 시각화
grid <- diamonds2 %>%
  data_grid(carat = seq_range(carat, 20)) %>%
  mutate(lcarat = log2(carat)) %>%
  add_predictions(mod_diamond, "lprice") %>%
  mutate(price = 2^lprice)

ggplot(diamonds2, aes(carat, price)) +
  geom_hex(bins = 50) +
  geom_line(data = grid, color = "red", size = 1)
```

![carat model prediction](@/assets/images/2022-09-12_모델링2_files/2022-09-12_모델링2_16_1.png)

### 잔차 분석을 통한 품질 효과 확인

```r
# 잔차 계산 및 시각화
diamonds2 <- diamonds2 %>%
  add_residuals(mod_diamond, "lresid")

# 캐럿 효과 제거 후 품질별 분석
ggplot(diamonds2, aes(cut, lresid)) + geom_boxplot()
ggplot(diamonds2, aes(color, lresid)) + geom_boxplot()
ggplot(diamonds2, aes(clarity, lresid)) + geom_boxplot()
```

![residual analysis cut](@/assets/images/2022-09-12_모델링2_files/2022-09-12_모델링2_20_0.png)

![residual analysis color](@/assets/images/2022-09-12_모델링2_files/2022-09-12_모델링2_20_1.png)

![residual analysis clarity](@/assets/images/2022-09-12_모델링2_files/2022-09-12_모델링2_20_2.png)

#### 🎯 문제 해결!
**캐럿 효과를 제거한 후에는 예상대로 품질이 좋을수록 높은 가격**을 보입니다. 초기 역설은 혼재변수 때문이었습니다.

### 통합 모델 구축

```r
# 모든 품질 변수를 포함한 종합 모델
mod_diamond2 <- lm(
  lprice ~ lcarat + color + cut + clarity,
  data = diamonds2
)

# 모델 예측값 생성 (대표값 사용)
grid <- diamonds2 %>%
  data_grid(cut, .model = mod_diamond2) %>%
  add_predictions(mod_diamond2)

ggplot(grid, aes(cut, pred)) +
  geom_point()
```

![comprehensive model predictions](@/assets/images/2022-09-12_모델링2_files/2022-09-12_모델링2_27_0.png)

### 이상값 탐지 및 분석

```r
# 큰 잔차를 가진 다이아몬드 찾기
diamonds2 <- diamonds2 %>%
  add_residuals(mod_diamond2, "lresid2")

# 이상값 확인
diamonds2 %>%
  filter(abs(lresid2) > 1) %>%
  add_predictions(mod_diamond2) %>%
  mutate(pred = round(2^pred)) %>%
  select(price, pred, carat:table, x:z) %>%
  arrange(price)
```

#### 📊 잔차 해석
- **잔차 -1**: 예측 가격의 절반 (2^(-1) = 0.5)
- **잔차 +1**: 예측 가격의 두 배 (2^1 = 2.0)
- **이상값**: 모델이 예측하지 못한 특수한 케이스들

## 3. 예제 2: 항공편 운항 패턴 분석

### 시계열 데이터 생성

```r
# 일별 항공편 수 집계
daily <- flights %>%
  mutate(date = make_date(year, month, day)) %>%
  group_by(date) %>%
  summarise(n = n())

# 전체 시계열 시각화
ggplot(daily, aes(date, n)) +
  geom_line()
```

![daily flights timeline](@/assets/images/2022-09-12_모델링2_files/2022-09-12_모델링2_36_0.png)

### 요일 효과 분석

```r
# 요일 변수 추가
daily <- daily %>%
  mutate(wday = wday(date, label = TRUE))

# 요일별 항공편 수 분포
ggplot(daily, aes(wday, n)) +
  geom_boxplot()
```

![weekday effect](@/assets/images/2022-09-12_모델링2_files/2022-09-12_모델링2_43_0.png)

#### 🔍 비즈니스 인사이트
- **주말 효과**: 토요일과 일요일에 항공편 수 감소
- **업무일 패턴**: 월-금요일은 비교적 일정한 수준
- **토요일 최저**: 가족과의 시간을 선호하는 문화

### 요일 효과 제거 모델

```r
# 요일 기반 모델
mod <- lm(n ~ wday, data = daily)

# 예측값과 원데이터 비교
grid <- daily %>%
  data_grid(wday) %>%
  add_predictions(mod, "n")

ggplot(daily, aes(wday, n)) +
  geom_boxplot() +
  geom_point(data = grid, color = "red", size = 4)
```

![weekday model predictions](@/assets/images/2022-09-12_모델링2_files/2022-09-12_모델링2_45_0.png)

### 잔차를 통한 숨겨진 패턴 발견

```r
# 잔차 계산 및 시계열 분석
daily <- daily %>%
  add_residuals(mod)

ggplot(daily, aes(date, resid)) +
  geom_ref_line(h = 0) +
  geom_line()
```

![residual time series](@/assets/images/2022-09-12_모델링2_files/2022-09-12_모델링2_47_0.png)

#### 📈 새로운 패턴 발견
- **계절성**: 여름 증가, 겨울 감소
- **특별일 효과**: 휴일에 항공편 수 급감
- **장기 트렌드**: 연중 변화 패턴

### 요일별 세부 분석

```r
# 요일별 색깔 구분 시계열
ggplot(daily, aes(date, resid, color = wday)) +
  geom_ref_line(h = 0) +
  geom_line()
```

![weekday colored residuals](@/assets/images/2022-09-12_모델링2_files/2022-09-12_모델링2_49_0.png)

#### 💡 토요일 특이점 발견
**토요일의 계절적 변화가 다른 요일과 다름**을 발견했습니다. 여름에는 예측보다 많고, 가을에는 적습니다.

### 특별한 날들 식별

```r
# 큰 음의 잔차를 가진 날들 (항공편 수 급감)
daily %>%
  filter(resid < -100)
#   date         n  wday     resid
# 1 2013-01-01  842   Tue  -109.4  # 신정
# 2 2013-07-04  737   Thu  -228.8  # 독립기념일  
# 3 2013-11-28  634   Thu  -331.8  # 추수감사절
# 4 2013-11-29  661   Fri  -306.5  # 추수감사절 다음날
# 5 2013-12-25  719   Wed  -243.7  # 크리스마스
```

### 장기 트렌드 시각화

```r
# 매끄러운 추세선 추가
daily %>%
  ggplot(aes(date, resid)) +
  geom_ref_line(h = 0) +
  geom_line(color = "grey50") +
  geom_smooth(se = FALSE, span = 0.20)
```

![long term trend](@/assets/images/2022-09-12_모델링2_files/2022-09-12_모델링2_53_1.png)

### 학기 효과 모델링

```r
# 학기 구분 함수 정의
term <- function(date){
  cut(date,
      breaks = ymd(20130101, 20130605, 20130825, 20140101),
      labels = c("spring", "summer", "fall")
  )
}

daily <- daily %>%
  mutate(term = term(date))

# 학기별 토요일 패턴 확인
daily %>%
  filter(wday == "Sat") %>%
  ggplot(aes(date, n, color = term)) +
  geom_point(alpha = 1/3) +
  geom_line() +
  scale_x_date(
    NULL,
    date_breaks = "1 month", 
    date_labels = "%b"
  )
```

![Saturday seasonal pattern](@/assets/images/2022-09-12_모델링2_files/2022-09-12_모델링2_60_0.png)

### 학기-요일 상호작용 모델

```r
# 학기별 요일 효과 모델
ggplot(daily, aes(wday, n, color = term)) +
  geom_boxplot()
```

![term weekday interaction](@/assets/images/2022-09-12_모델링2_files/2022-09-12_모델링2_62_0.png)

```r
# 상호작용 모델 구축
mod1 <- lm(n ~ wday, data = daily)              # 기본 모델
mod2 <- lm(n ~ wday * term, data = daily)       # 상호작용 모델

# 모델 비교
daily %>%
  gather_residuals(without_term = mod1, with_term = mod2) %>%
  ggplot(aes(date, resid, color = model)) +
  geom_line(alpha = 0.75)
```

![model comparison](@/assets/images/2022-09-12_모델링2_files/2022-09-12_모델링2_65_0.png)

### 강건한 회귀 모델

```r
# 이상값에 강건한 모델 (MASS::rlm)
mod3 <- MASS::rlm(n ~ wday * term, data = daily)

daily %>%
  add_residuals(mod3, "resid") %>%
  ggplot(aes(date, resid)) +
  geom_hline(yintercept = 0, size = 2, color = "white") +
  geom_line()
```

![robust regression](@/assets/images/2022-09-12_모델링2_files/2022-09-12_모델링2_69_0.png)

### 스플라인을 사용한 유연한 모델

```r
# 자연 스플라인을 사용한 연중 패턴 모델링
mod_spline <- MASS::rlm(n ~ wday * ns(date, 5), data = daily)

daily %>%
  data_grid(wday, date = seq_range(date, n = 13)) %>%
  add_predictions(mod_spline) %>%
  ggplot(aes(date, pred, color = wday)) +
  geom_line() +
  geom_point()
```

![spline model predictions](@/assets/images/2022-09-12_모델링2_files/2022-09-12_모델링2_80_0.png)

## 4. 모델링 전략과 실무 팁

### 🔄 반복적 모델링 워크플로우

1. **탐색적 분석**: 시각화를 통한 패턴 발견
2. **기본 모델**: 주요 효과부터 모델링
3. **잔차 분석**: 놓친 패턴 찾기
4. **모델 개선**: 새로운 변수나 상호작용 추가
5. **검증**: 도메인 지식과 일치 여부 확인

### 📊 변수 변환 전략

| 상황 | 변환 방법 | 목적 |
|------|-----------|------|
| **치우친 분포** | 로그 변환 | 정규분포에 가깝게 |
| **곡선 관계** | 다항식, 스플라인 | 비선형 관계 포착 |
| **주기성** | 삼각함수 | 계절성, 주기 패턴 |
| **범주 통합** | 팩터 재코딩 | 의미 있는 그룹화 |

### 🎯 모델 해석 가이드

#### 로그 변환된 모델에서
- **계수 β**: log(y) 단위당 변화
- **exp(β)**: y의 배수 변화
- **100*(exp(β)-1)%**: 퍼센트 변화

#### 잔차 분석에서
- **패턴 존재**: 모델이 놓친 구조
- **이분산성**: 변수 변환 필요
- **이상값**: 특수 케이스나 오류

### ⚠️ 일반적인 함정들

1. **혼재변수 무시**: Simpson's Paradox
2. **과적합**: 너무 복잡한 모델
3. **외삽의 위험**: 훈련 범위 밖 예측
4. **인과관계 오해**: 상관관계 ≠ 인과관계

## 💡 실무 활용 팁

### ✅ 변수 생성 함수화

```r
# 재사용 가능한 변수 생성 함수
compute_vars <- function(data){
  data %>%
    mutate(
      term = term(date),
      wday = wday(date, label = TRUE),
      month = month(date),
      is_holiday = date %in% holidays
    )
}
```

### 📈 모델 비교 체크리스트

| 기준 | 측정 방법 | 목표 |
|------|-----------|------|
| **예측 성능** | RMSE, R² | 낮은 RMSE, 높은 R² |
| **복잡도** | 변수 수, AIC | 단순함과 성능의 균형 |
| **해석성** | 계수 유의성 | 의미 있는 관계 |
| **일반화** | 교차검증 | 새 데이터 성능 |

### 🔍 진단 함수 예제

```r
# 종합 모델 진단 함수
diagnose_model <- function(model, data) {
  residuals <- residuals(model)
  
  list(
    rmse = sqrt(mean(residuals^2)),
    r_squared = summary(model)$r.squared,
    shapiro_p = shapiro.test(residuals)$p.value,
    bp_test = car::ncvTest(model)$p  # 등분산 검정
  )
}
```

## 마무리

**실전 모델링**에서 가장 중요한 것은 **데이터와의 대화**입니다. 이번 포스팅에서 다룬 두 가지 사례를 통해 다음을 배울 수 있었습니다:

- **다이아몬드 분석**: 혼재변수의 중요성과 로그 변환의 효과
- **항공편 분석**: 시계열 패턴과 도메인 지식 결합의 필요성

### 핵심 교훈들

1. **직관과 다른 결과**: 항상 혼재변수 확인
2. **시각화 우선**: 패턴을 눈으로 먼저 확인
3. **잔차 분석**: 모델이 놓친 부분 탐색
4. **도메인 지식**: 통계와 실무 지식의 결합
5. **반복적 개선**: 한 번에 완벽한 모델은 없음

**실무에서는 완벽한 모델보다 이해하기 쉽고 실행 가능한 모델**이 더 가치 있습니다. 복잡성과 해석 가능성 사이의 균형을 찾아가며, 지속적으로 모델을 개선해 나가는 것이 성공적인 모델링의 핵심입니다!

다음 포스팅에서는 **머신러닝 기법과 모델 선택 전략**에 대해 다뤄보겠습니다. 📊